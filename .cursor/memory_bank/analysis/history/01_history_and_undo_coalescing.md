# ===============================================
# Lexical History 및 Undo 병합(Coalescing) 심층 분석
# ===============================================
# 이 문서는 Lexical의 HistoryPlugin이 Undo/Redo 동작을 어떻게 관리하는지,
# 특히 연속된 입력을 하나의 단위로 묶는 'Undo Coalescing'의 원리를 심층 분석합니다.
# 원본: packages/lexical-website/docs/concepts/history.md
# ===============================================

## 1. Undo Coalescing (입력 병합) 이란?

사용자가 텍스트 에디터에서 작업을 되돌릴 때(Undo), 글자를 하나하나 입력한 것을 각각 되돌려야 한다면 매우 불편할 것입니다. 'Undo Coalescing'은 **연속된 타이핑과 같은 관련된 입력들을 하나의 논리적인 단위로 묶어, 한 번의 Undo 제스처로 전체가 되돌려지도록 하는 기능**입니다.

이는 좋은 사용자 경험을 제공하는 데 매우 핵심적인 부분입니다.

---

## 2. 병합(Coalescing) 대상이 되는 입력

`HistoryPlugin`은 모든 입력을 병합하지 않습니다. '연속된 타이핑'으로 간주되는 특정 행동들만 병합 대상이 됩니다.

-   **문자 입력**: 키보드로 글자를 입력하는 행위.
-   **백스페이스**: `Backspace` 키를 이용해 뒤로 글자를 지우는 행위.
-   **삭제**: `Delete` 키를 이용해 앞으로 글자를 지우는 행위.

> **흥미로운 점**: Lexical은 위 세 가지 행동(입력, 백스페이스, 삭제)을 서로 오가는 것도 하나의 '연속된 타이핑'으로 간주하여 병합합니다. 사용자가 오타를 수정하며 타이핑하는 자연스러운 흐름을 반영한 것입니다. (이는 Google Docs나 Quip과는 다른 동작입니다.)

---

## 3. 병합이 중단되는 조건

'연속된 타이핑'은 특정 이벤트가 발생하면 중단되고, 그 시점부터 새로운 Undo 기록이 시작됩니다.

-   **시간 초과 (Timeout)**: 마지막 입력 후 일정 시간(보통 1~5초)이 지나면 세션이 중단됩니다.
-   **선택 영역 변경**: 화살표 키로 커서를 이동하거나, 마우스로 텍스트를 선택하는 등, 타이핑으로 인한 자동 커서 이동이 아닌 모든 선택 변경은 세션을 중단시킵니다.
-   **엔터 키 입력**: `Enter` 키를 눌러 새로운 문단을 시작하면(hard return) 세션이 중단됩니다. (`Shift+Enter`로 줄바꿈만 하는 soft return은 중단하지 않습니다.)
-   **포커스 잃음**: 에디터 외부를 클릭하거나 다른 창으로 전환하여 포커스를 잃으면 세션이 중단됩니다.
-   **특수 입력**:
    -   **문자 조합(Composition)**: 한글, CJK, 이모지 등 조합형 문자를 입력하기 시작하면 세션이 중단됩니다.
    -   **자동 완성/수정**: 맞춤법 교정과 같은 자동 텍스트 변환이 일어나면 세션이 중단됩니다.
    -   **복사 및 붙여넣기**: 복사, 잘라내기, 붙여넣기 동작은 세션을 중단시킵니다.

이러한 명확한 규칙 덕분에, Lexical의 Undo/Redo는 사용자의 의도에 가깝게 동작하며 예측 가능성을 높입니다.

---

## 4. History 관련 주요 태그

`HistoryPlugin`은 특정 업데이트 태그에 반응하여 동작을 제어합니다.

-   **`HISTORY_PUSH_TAG`**: 이 태그가 포함된 업데이트는, 병합 조건과 상관없이 **강제로 새로운 Undo 기록을 생성**합니다.
-   **`HISTORY_MERGE_TAG`**: 이 태그가 포함된 업데이트는, 병합 중단 조건과 상관없이 **강제로 이전 Undo 기록에 병합**됩니다.
-   **`HISTORIC_TAG`**: 이 태그는 Undo/Redo 동작 자체에 의해 발생하는 업데이트임을 나타냅니다. (예: 이 태그가 있는 업데이트는 다시 Undo 스택에 쌓이지 않도록 함)

이 태그들을 활용하면, 플러그인에서 Undo/Redo 동작을 더욱 정교하게 제어할 수 있습니다. 