# Flexion Core

## 1. Overview

Flexionì€ ERP UIë¥¼ ìœ„í•œ **ìœ ì—°í•˜ê³  í™•ì¥ ê°€ëŠ¥í•œ í”„ë ˆì„ì›Œí¬**ë¡œ, â€˜êµ¬ë¶€ë¦¬ë‹¤â€™ë¼ëŠ” ì–´ì›ì²˜ëŸ¼ ë‹¤ì–‘í•œ í™˜ê²½ê³¼ ìš”êµ¬ì‚¬í•­ì— ë§ì¶° í˜•íƒœë¥¼ ë°”ê¿€ ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.

í•µì‹¬ ê°€ì¹˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

* **ìœ ì—°ì„±**: React/Vue/ìˆœìˆ˜ HTML ë“± ë‹¤ì–‘í•œ UI ìŠ¤íƒ ì§€ì›
* **í™•ì¥ì„±**: ì™¸ë¶€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§/í”ŒëŸ¬ê·¸ì¸/ë°ì´í„° ëª¨ë¸ì„ ì•ˆì „í•˜ê²Œ ì£¼ì…
* **ëª¨ë“ˆì„±**: ë…ë¦½ ëª¨ë“ˆ ì¡°í•©ìœ¼ë¡œ ë¹ ë¥¸ ë³€í™” ëŒ€ì‘



## 2. í•µì‹¬ ëª¨ë“ˆ êµ¬ì„±

### flexion-ui

ERP ì—…ë¬´ì— íŠ¹í™”ëœ **ì…ë ¥/í‘œì‹œ ì»´í¬ë„ŒíŠ¸**(ìˆ«ì/í…ìŠ¤íŠ¸/ë‚ ì§œ/ì„ íƒ ë“±)ë¥¼ ì œê³µ.

### flexion-grid

ëŒ€ê·œëª¨ ë°ì´í„° í‘œì‹œÂ·í¸ì§‘ì„ ìœ„í•œ **ê·¸ë¦¬ë“œ ì—”ì§„**. ê°€ìƒ ìŠ¤í¬ë¡¤, Lazy Rendering, ì…€ ë‹¨ìœ„ í¸ì§‘/ê²€ì¦ ì§€ì›.

### shared

ê³µí†µ ë¡œì§(**State API, Command ë²„ìŠ¤, Definition(AST)** ë“±)ì„ ì œê³µí•˜ëŠ” ë ˆì´ì–´.

> ìœ„ 3ê°œ ì™¸ì—ë„ í¸ì§‘ê¸°, ë ˆì´ì•„ì›ƒ, í…Œë§ˆ ë“± **nê°œì˜ ëª¨ë“ˆ**ì´ ì¡´ì¬í•©ë‹ˆë‹¤.



### 2-1. **shared** ëª¨ë“ˆ

**shared** ëª¨ë“ˆì€ Flexion ERP ì „ë°˜ì—ì„œ ê³µí†µì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” **í•µì‹¬ ì¸í”„ë¼ ë ˆì´ì–´**ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ëŠ” `flexion-ui`, `flexion-grid`, ê·¸ë¦¬ê³  í¸ì§‘ê¸°Â·ë ˆì´ì•„ì›ƒÂ·í…Œë§ˆ ë“± ëª¨ë“  ëª¨ë“ˆì—ì„œ **ë™ì¼í•œ ìƒíƒœÂ·ëª…ë ¹Â·ì •ì˜ êµ¬ì¡°**ë¥¼ ì¼ê´€ì„± ìˆê²Œ í™œìš©í•˜ë„ë¡ í•©ë‹ˆë‹¤.

#### ğŸ“Œ ì£¼ìš” êµ¬ì„±

| êµ¬ì„± ìš”ì†Œ                  | ì„¤ëª…                                                                                       |
| ---------------------- | ---------------------------------------------------------------------------------------- |
| **State API**          | MobX ê¸°ë°˜ì˜ ìƒíƒœ ê´€ë¦¬ APIë¡œ, UIì™€ ë°ì´í„° ëª¨ë¸ ê°„ì˜ ë™ê¸°í™”ë¥¼ ì§€ì›                                               |
| **Command Bus**        | ì „ì—­ ëª…ë ¹ ë””ìŠ¤íŒ¨ì²˜ë¡œ, ëª¨ë“ˆ ê°„ ì´ë²¤íŠ¸/ëª…ë ¹ ì „ë‹¬ ë° ì²˜ë¦¬ íë¦„ ì œì–´                                                   |
| **Definition (AST)**   | UI ë° ë°ì´í„° ëª¨ë¸ ì •ì˜ë¥¼ AST í˜•íƒœë¡œ ê´€ë¦¬í•˜ê³ , Definition Normalization â†’ AST Conversion íŒŒì´í”„ë¼ì¸ì˜ í•µì‹¬ ë°ì´í„° êµ¬ì¡° |
| **Validation & Rules** | í•„ë“œ ë‹¨ìœ„, í¼ ë‹¨ìœ„, ê·¸ë¦¬ë“œ ë‹¨ìœ„ì˜ ì…ë ¥ ê²€ì¦ ë¡œì§ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê³µí†µí™”                                               |
| **Utilities & Types**  | ëª¨ë“ˆ ê°„ ê³µìœ ë˜ëŠ” ìœ í‹¸ í•¨ìˆ˜, ê³µìš© íƒ€ì…, ìƒìˆ˜ ì •ì˜ ë“±                                                          |



## 3. ì•„í‚¤í…ì²˜ ê°œìš”

```mermaid
graph LR
  subgraph ECOUNT[ecount framework]
    POL[Policies/Standards]
  end

  subgraph ERP[flexion-erp]
    CXT[FlexionContextProvider]
    ERPSVC[ERPService]
  end

  subgraph FCORE[flexion framework]
    subgraph UI[flexion-ui]
      UIKIT[Inputs â€¢ Selectors â€¢ Display]
    end
    GRID[flexion-grid]
    SHARED[shared: state â€¢ command â€¢ definition]
    ETC[... other n modules]
  end

  POL --> CXT
  CXT --> ERPSVC
  ERPSVC --> FCORE
  FCORE --> UI
  FCORE --> GRID
  UI --> SHARED
  GRID --> SHARED
```



## 4. ë°ì´í„° ë° ì œì–´ íë¦„

Flexionì€ **ERPServiceë¥¼ í†µí•´ ì™¸ë¶€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**(í”ŒëŸ¬ê·¸ì¸/í¬ë§·í„°/ë°ì´í„° ëª¨ë¸ ì—°ë™)ì„ ì£¼ì…ë°›ì•„ ë™ì‘í•©ë‹ˆë‹¤.

**ìˆ«ì ì…ë ¥ â†’ í”ŒëŸ¬ê·¸ì¸ â†’ Formatter â†’ UI ì—…ë°ì´íŠ¸ (ë¶€ê°€ ì„¤ëª… ë„ì‹í™”)**

```mermaid
graph LR
  A[User Input: ìˆ«ì ì…ë ¥] --> B[Command ìƒì„±: INPUT/NUMBER/CHANGE]
  B --> C[Plugin êµ¬ë…]
  C --> D[Formatter í˜¸ì¶œ]
  D --> E[ë°ì´í„° ë³€í™˜]
  E --> F[FlexionRuntime.$getNodeByKeyë¡œ ìƒíƒœ patch]
  F --> G[UI ì»´í¬ë„ŒíŠ¸ ì—…ë°ì´íŠ¸]
```

### 4.1 FlexionNode(Component)

FlexionNode(Component)ëŠ” **ë…¸ë“œ ë‹¨ìœ„ì˜ ë°ì´í„°/ìƒíƒœ**ì™€ ì´ë¥¼ ì‹œê°í™”í•˜ëŠ” **Decorator Component**(React/Vue/HTML)ì˜ ê²°í•©ì…ë‹ˆë‹¤.

* **ì—­í•  ë¶„ë¦¬**: ë…¸ë“œëŠ” ë°ì´í„°/ì§ë ¬í™”, ì»´í¬ë„ŒíŠ¸ëŠ” ë Œë”/ìƒí˜¸ì‘ìš© ë‹´ë‹¹
* **ìƒíƒœ ì ‘ê·¼**: ë³„ë„ ìŠ¤í† ì–´ ë…¸ì¶œ ì—†ì´ **State API**(`$getState`, `$getNodeByKey`)ë¡œ ì¡°íšŒ/ê°±ì‹ 
* **ë‹¤ì¤‘ UI ìŠ¤íƒ**: ë™ì¼ ë…¸ë“œë¥¼ ë‹¤ì–‘í•œ UI ê¸°ìˆ ë¡œ ë°ì½”ë ˆì´ì…˜ ê°€ëŠ¥

```mermaid
classDiagram
  class FlexionNode {
    +id: string
    +type: string
    +state: Record
    +serialize(): JSON
    +deserialize(json): FlexionNode
    +patch(partialState): void
  }
  class DecoratorComponent {
    +props: any
    +render()
    +useRuntime(runtime)
  }
  class FlexionRuntime {
    +$getState(): StateSnapshot
    +$getNodeByKey(key): FlexionNode
  }
  FlexionNode <.. DecoratorComponent : observes
  DecoratorComponent ..> FlexionRuntime : queries/updates via API
  FlexionRuntime o-- FlexionNode : provides access to
```



### 4.2 Command

CommandëŠ” Flexionì˜ **ë°ì´í„°Â·ì´ë²¤íŠ¸ íë¦„ì„ í‘œì¤€í™”**í•˜ëŠ” í•µì‹¬ ë‹¨ìœ„ì…ë‹ˆë‹¤. ëª¨ë“  ì´ë²¤íŠ¸/ë³€ê²½ì€ `type + payload(+ meta)` í˜•íƒœì˜ Commandë¡œ ë²„ìŠ¤ë¥¼ í†µí•´ ì „ë‹¬ë©ë‹ˆë‹¤.

#### 4.2.1 Command ë²„ìŠ¤(Command Bus)

í¼ë¸”ë¦¬ì‹œ â†’ ë¯¸ë“¤ì›¨ì–´ â†’ í•¸ë“¤ëŸ¬/í”ŒëŸ¬ê·¸ì¸ â†’ ìƒíƒœ ê°±ì‹  â†’ UI ì—…ë°ì´íŠ¸.

```mermaid
graph LR
  P[Publisher] --> B[CommandBus]
  B --> M[Middleware]
  M --> H[Handlers/Plugins]
  H --> S[$getNodeByKey/$getState]
  S --> U[UI Re-render]
```

* **Publisher**: UI/í”ŒëŸ¬ê·¸ì¸/ì„œë¹„ìŠ¤ ë“± ëª…ë ¹ ë°œí–‰ ì£¼ì²´
* **Middleware**: ë¡œê¹…Â·ê²€ì¦Â·ì •ì±…Â·ìŠ¤ë¡œí‹€ ë“± ì „/í›„ ì²˜ë¦¬
* **Handlers/Plugins**: Command ì²˜ë¦¬ í›„ State API ê°±ì‹ 

#### 4.2.2 Command ìŠ¤í‚¤ë§ˆ(ê¶Œì¥)

```ts
export type Command<P = any, M = any> = {
  type: string;                     // ì˜ˆ: 'INPUT/NUMBER/CHANGE'
  payload: P;                       // ì§ë ¬í™” ê°€ëŠ¥í•œ ìˆœìˆ˜ ë°ì´í„°
  meta?: M & {                      // (ì„ íƒ) íŠ¸ë ˆì´ì‹±/ì •ì±…ìš© ê³µí†µ ë©”íƒ€
    correlationId?: string;
    causationId?: string;
    ts?: number | string;
    userId?: string;
    source?: 'ui' | 'plugin' | 'service';
    idempotencyKey?: string;
  };
};
```

#### 4.2.3 ë¼ì´í”„ì‚¬ì´í´

1. ìƒì„± â†’ 2) ë°œí–‰ â†’ 3) ë¯¸ë“¤ì›¨ì–´ â†’ 4) í•¸ë“¤ëŸ¬/í”ŒëŸ¬ê·¸ì¸ â†’ 5) **State API ê°±ì‹ ** â†’ 6) UI ë¦¬ë Œë” â†’ 7) ê²°ê³¼ ì´ë²¤íŠ¸(`.../SUCCEEDED|REJECTED`).

#### 4.2.4 ê²€ì¦/ì •ì±… í›…

```ts
bus.use('INPUT/NUMBER/CHANGE', [schemaValidate, domainValidate, policyGuard]);
```

#### 4.2.5 ìˆœì„œ/ì¤‘ë³µ ì²˜ë¦¬

* ë™ì¼ `path` ìŠ¤íŠ¸ë¦¼ ë‚´ **FIFO** ë³´ì¥ ê¶Œì¥
* `idempotencyKey`ë¡œ ì¤‘ë³µ ì•ˆì „ ì²˜ë¦¬
* ë©€í‹° ìŠ¤íŠ¸ë¦¼ì€ **ìµœì¢…ì  ì¼ê´€ì„±** í—ˆìš©

#### 4.2.6 ì˜ˆì‹œ ìŠ¤í™(ë°œì·Œ)

```ts
export type NumberChangeCmd = Command<{
  path: string; raw: string; locale?: string; formatKey?: string; options?: Record<string, unknown>;
}>;
export type GridCellUpdateCmd = Command<{
  gridId: string; rowKey: string; colKey: string; value: unknown;
}>;
```

#### 4.2.7 ì˜ˆì‹œ: ìˆ«ì ì…ë ¥ ì»´í¬ë„ŒíŠ¸ì—ì„œ Command ë°œí–‰

```tsx
import { useState } from 'react';

type Props = { bus: { publish: (cmd: any) => void }; nodeId: string; locale?: string; formatKey?: string };
export function NumberInput({ bus, nodeId, locale = 'ko-KR', formatKey = 'number.currency' }: Props) {
  const [value, setValue] = useState('');
  const onChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value; setValue(raw);
    bus.publish({ type: 'INPUT/NUMBER/CHANGE', payload: { path: nodeId, raw, locale, formatKey }, meta: { source: 'ui' } });
  };
  return <input value={value} onChange={onChange} inputMode="decimal" placeholder="ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”" />;
}
```



### 4.3 Plugin

í”ŒëŸ¬ê·¸ì¸ì€ **React ê¸°ë°˜ì˜ í—¤ë“œë¦¬ìŠ¤ í™•ì¥ ì»´í¬ë„ŒíŠ¸**ë¡œ, Command íë¦„ì„ êµ¬ë…í•˜ê³  ERPService/State APIì™€ ìƒí˜¸ì‘ìš©í•´ ìƒíƒœë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.

#### 4.3.1 ìˆ«ì ì…ë ¥ í¬ë§· í”ŒëŸ¬ê·¸ì¸ ì˜ˆì‹œ

```tsx
function NumberFormatPlugin({ bus, erp, flex }) {
  useEffect(() => {
    const off = bus.on('INPUT/NUMBER/CHANGE', async (cmd) => {
      const { path, raw, locale, formatKey = 'number.currency', options } = cmd.payload;
      const formatter = erp.getFormatter?.(formatKey);
      try {
        const display = formatter ? await formatter.format(raw, { locale, options }) : raw;
        flex.$getNodeByKey(path)?.patch({ display, numeric: Number(raw) });
      } catch {
        flex.$getNodeByKey(path)?.patch({ display: raw, numeric: Number(raw) });
      }
    });
    return () => off();
  }, [bus, erp, flex]);
  return null; // headless
}
```



### 4.4 State API

Flexionì€ ë³„ë„ ìŠ¤í† ì–´ë¥¼ ë…¸ì¶œí•˜ì§€ ì•Šê³  **í•¨ìˆ˜í˜• ëŸ°íƒ€ì„ API**ë¡œ ìƒíƒœë¥¼ ë‹¤ë£¹ë‹ˆë‹¤.

#### 4.4.1 ì„¤ê³„ ì›ì¹™

* `$getState()` ìŠ¤ëƒ…ìƒ·ì€ **ì½ê¸° ì „ìš©**
* ê°±ì‹ ì€ `$getNodeByKey(key)`ë¡œ í•¸ë“¤ì„ ì–»ì–´ `patch()`ë¡œë§Œ ìˆ˜í–‰
* `patch()` í›„ ê´€ë ¨ UI ìë™ ë¦¬ë Œë”, ì™¸ë¶€ ì›ì‹œ ê°ì²´ ì§ì ‘ ë³€í˜• ê¸ˆì§€

#### 4.4.2 API í‘œë©´(ê¶Œì¥)

```ts
interface FlexionRuntime {
  $getState(): unknown; // Readonly snapshot
  $getNodeByKey<T = any>(key: string): FlexionNodeHandle<T> | null;
}
interface FlexionNodeHandle<T = any> {
  value: Readonly<T>;
  patch(delta: Partial<T>): void;
}
```

#### 4.4.3 ê¸°ë³¸ ì‚¬ìš© íŒ¨í„´

```ts
const snap = flex.$getState(); // ì½ê¸° ì „ìš©
const node = flex.$getNodeByKey<{ numeric: number; display: string }>('form.items[0].price');
if (node) node.patch({ display: node.value.numeric.toLocaleString('ko-KR') });
```

#### 4.4.4 íŒŒìƒ ê°’ ë™ê¸°í™”

```ts
function syncAmount({ priceKey, qtyKey, amountKey }: { priceKey: string; qtyKey: string; amountKey: string }) {
  const price = flex.$getNodeByKey<{ numeric: number }>(priceKey)?.value.numeric ?? 0;
  const qty   = flex.$getNodeByKey<{ numeric: number }>(qtyKey)?.value.numeric ?? 0;
  flex.$getNodeByKey<{ numeric: number; display: string }>(amountKey)?.patch({ numeric: price * qty, display: String(price * qty) });
}
```

#### 4.4.5 ë¹„ë™ê¸° í¬ë§·/ê²€ì¦ ê²½ìŸ ìƒíƒœ ë°©ì§€

```ts
let lastToken = 0;
bus.on('INPUT/NUMBER/CHANGE', async (cmd) => {
  const token = ++lastToken;
  const { path, raw, locale, formatKey = 'number.currency' } = cmd.payload;
  const node = flex.$getNodeByKey<{ display: string; numeric: number }>(path);
  if (!node) return;
  const formatter = erp.getFormatter?.(formatKey);
  const display = formatter ? await formatter.format(raw, { locale }) : raw;
  if (token !== lastToken) return; // ìµœì‹  ì…ë ¥ë§Œ ë°˜ì˜
  node.patch({ display, numeric: Number(raw) });
});
```

#### 4.4.6 ì„±ëŠ¥/í…ŒìŠ¤íŠ¸ íŒ

* ê³ ë¹ˆë„ ì…ë ¥ì€ 120â€“200ms **ë””ë°”ìš´ìŠ¤** ê¶Œì¥
* ë™ì¼ ê°’ì´ë©´ `patch()` ìƒëµ
* í…ŒìŠ¤íŠ¸: `$getNodeByKey` ëª©/ìŠ¤íŒŒì´ë¡œ **patch í˜¸ì¶œ** ë‹¨ì–¸, ê²½ìŸ ìƒíƒœ ì‹œë‚˜ë¦¬ì˜¤ í¬í•¨



## ë¶€ë¡ A. (ì—„ê²© ë²„ì „) ìŠ¤í‚¤ë§ˆ/ë¯¸ë“¤ì›¨ì–´/ì»´í¬ë„ŒíŠ¸ ì˜ˆì‹œ

ì •ìˆ˜ë¶€Â·ì†Œìˆ˜ë¶€ ìë¦¿ìˆ˜/ë¶€í˜¸ í—ˆìš©/ê°’ ë²”ìœ„ê¹Œì§€ í†µì œí•˜ëŠ” **Zod ìŠ¤í‚¤ë§ˆ**, **íƒ€ì…ë“œ ë¹„ë™ê¸° ë¯¸ë“¤ì›¨ì–´**, ê·¸ë¦¬ê³  ì´ë¥¼ í™œìš©í•˜ëŠ” **NumberInput/í”ŒëŸ¬ê·¸ì¸** ì˜ˆì‹œì…ë‹ˆë‹¤.

### A.1 Zod ìŠ¤í‚¤ë§ˆ (êµ¬ì„± ê°€ëŠ¥í•œ ì œì•½)

```ts
import { z } from 'zod';
export type NumberConstraints = {
  maxIntegerDigits: number;
  maxFractionDigits: number;
  allowNegative?: boolean;
  min?: number;
  max?: number;
};
export const makeRawNumberSchema = (c: NumberConstraints) => z
  .string()
  .min(1, 'ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤')
  .max(64, 'ì…ë ¥ ê¸¸ì´ê°€ ë„ˆë¬´ ê¹ë‹ˆë‹¤')
  .regex(/^[-]?\d*(?:\.\d*)?$/, 'ìˆ«ì í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤')
  .refine(v => (c.allowNegative ?? false) || !v.startsWith('-'), 'ìŒìˆ˜ëŠ” í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤')
  .refine(v => { const [i = ''] = v.split('.'); return i.replace(/^[-]/,'').length <= c.maxIntegerDigits; }, 'ì •ìˆ˜ë¶€ ìë¦¿ìˆ˜ ì´ˆê³¼')
  .refine(v => (v.split('.')[1]?.length ?? 0) <= c.maxFractionDigits, 'ì†Œìˆ˜ë¶€ ìë¦¿ìˆ˜ ì´ˆê³¼')
  .refine(v => { const n = Number(v); if (Number.isNaN(n)) return false; if (typeof c.min==='number' && n<c.min) return false; if (typeof c.max==='number' && n>c.max) return false; return true; }, 'í—ˆìš© ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤');
export const NumberChangeSchema = (c: NumberConstraints) => z.object({
  type: z.literal('INPUT/NUMBER/CHANGE'),
  payload: z.object({ path: z.string().min(1), raw: makeRawNumberSchema(c), locale: z.string().optional(), formatKey: z.string().optional(), options: z.record(z.any()).optional() }),
  meta: z.object({ source: z.enum(['ui','plugin','service']).optional(), correlationId: z.string().optional(), ts: z.union([z.number(), z.string()]).optional() }).optional(),
});
```

### A.2 íƒ€ì…ë“œ ë¯¸ë“¤ì›¨ì–´ & ë²„ìŠ¤ ì¸í„°í˜ì´ìŠ¤

```ts
export type TypedMiddleware<T> = (cmd: T, next: (cmd: T) => Promise<void>) => Promise<void>;
export interface CommandBus {
  publish<T>(cmd: T): void;
  on<T>(type: string, handler: (cmd: T) => void | Promise<void>): () => void;
  use<T>(type: string, mws: TypedMiddleware<T>[]): void;
}
const constraints: NumberConstraints = { maxIntegerDigits: 12, maxFractionDigits: 2, allowNegative: false, min: 0, max: 100_000_000 };
const schemaValidate: TypedMiddleware<any> = async (cmd, next) => {
  const parsed = NumberChangeSchema(constraints).safeParse(cmd);
  if (!parsed.success) { console.warn('Invalid command', parsed.error.flatten()); return; }
  await next(parsed.data);
};
const policyGuard: TypedMiddleware<any> = async (cmd, next) => { if (!hasAccess(cmd.payload.path)) return; await next(cmd); };
const auditLog: TypedMiddleware<any> = async (cmd, next) => { logCmd(cmd); await next(cmd); };
bus.use('INPUT/NUMBER/CHANGE', [schemaValidate, policyGuard, auditLog]);
```

### A.3 íƒ€ì… ê°•í™”ëœ NumberInput (UI ë‹¨ê³„ ë°©ì–´)

```tsx
import { useState } from 'react';
import { makeRawNumberSchema, NumberConstraints } from './schemas';

type Props = { bus: { publish: (cmd: any) => void }; nodeId: string; locale?: string; formatKey?: string; constraints?: NumberConstraints };
export function NumberInput({ bus, nodeId, locale = 'ko-KR', formatKey = 'number.currency', constraints = { maxIntegerDigits: 12, maxFractionDigits: 2, allowNegative: false } }: Props) {
  const [value, setValue] = useState('');
  const RawNumberSchema = makeRawNumberSchema(constraints);
  const onChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value; setValue(raw);
    const res = RawNumberSchema.safeParse(raw.replace(/,/g, ''));
    if (!res.success) return; // UIë‹¨ì—ì„œ ì¦‰ì‹œ ì°¨ë‹¨
    bus.publish({ type: 'INPUT/NUMBER/CHANGE', payload: { path: nodeId, raw: res.data, locale, formatKey, options: { constraints } }, meta: { source: 'ui' } });
  };
  return <input value={value} onChange={onChange} inputMode="decimal" placeholder={`ìµœëŒ€ ${constraints.maxIntegerDigits}ìë¦¬ / ì†Œìˆ˜ ${constraints.maxFractionDigits}ìë¦¬`} />;
}
```

### A.4 í”ŒëŸ¬ê·¸ì¸ í•¸ë“¤ëŸ¬ (ìŠ¤í‚¤ë§ˆ ì¬ê²€ì¦ + í¬ë§· + patch)

```ts
import { NumberChangeSchema, NumberConstraints } from './schemas';

bus.on('INPUT/NUMBER/CHANGE', async (cmd) => {
  const constraints: NumberConstraints | undefined = cmd.payload?.options?.constraints;
  const schema = constraints ? NumberChangeSchema(constraints) : NumberChangeSchema({ maxIntegerDigits: 12, maxFractionDigits: 2, allowNegative: false });
  const parsed = schema.safeParse(cmd);
  if (!parsed.success) return; // ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì´ë¯¸ ì°¨ë‹¨ë˜ì—ˆì–´ë„ 2ì¤‘ ë°©ì–´
  const { path, raw, locale, formatKey = 'number.currency', options } = parsed.data.payload;
  const node = flex.$getNodeByKey<{ display: string; numeric: number }>(path);
  if (!node) return;
  try {
    const display = erp.getFormatter?.(formatKey) ? await erp.getFormatter(formatKey)!.format(raw, { locale, options }) : raw;
    node.patch({ display, numeric: Number(raw) });
  } catch {
    node.patch({ display: raw, numeric: Number(raw) });
  }
});
```
